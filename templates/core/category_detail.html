{% extends "base.html" %}
{% load static %}

{% block title %}{{ category.title }} â€“ {{ site.site_name|default:"PerculaCMS" }}{% endblock %}
{% block meta_description %}{{ category.description|default:category.title|striptags }}{% endblock %}

{% block content %}
<div class="container py-5">
  <header class="mb-5 d-flex align-items-start justify-content-between gap-3">
    <div class="flex-grow-1">
      {% if category.icon %}
        <i class="{{ category.icon }} fs-2 me-2 text-primary"></i>
      {% endif %}
      <h1 class="display-5 fw-bold">{{ category.title }}</h1>
      {% if category.description %}
        <div class="lead text-muted">{{ category.description|safe }}</div>
      {% endif %}
    </div>

    <!-- CMS Action Buttons (admin only) -->
    {% if request.user.is_superuser or perms.core.manage_content %}
      <div class="d-flex flex-column gap-2 flex-shrink-0">
        <a href="{% url 'cms:page-create' %}?category={{ category.pk }}"
           class="btn btn-sm btn-outline-primary">
          <i class="bi bi-plus-lg me-1"></i>Seite
        </a>
        <button type="button" id="btn-edit-description"
                class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-pencil me-1"></i>Beschreibung bearbeiten
        </button>
      </div>
    {% endif %}
  </header>

  <!-- Description Editor (admin only, hidden by default) -->
  {% if request.user.is_superuser or perms.core.manage_content %}
  <section id="description-editor-section" class="mb-5 d-none">
    <div class="card border-secondary">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-pencil-square text-secondary"></i>
        <strong>Beschreibung bearbeiten</strong>
      </div>
      <div class="card-body">
        <div id="quill-description-editor" style="min-height:150px;"></div>
        <form method="post" action="{% url 'cms:category-description-edit' category.pk %}" id="description-form">
          {% csrf_token %}
          <textarea name="description" id="id_description" class="d-none"></textarea>
          <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="bi bi-check-lg me-1"></i>Speichern
            </button>
            <button type="button" id="btn-cancel-description" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-x-lg me-1"></i>Abbrechen
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
  {% endif %}

  {% if pages %}
    <div class="row g-4">
      {% for page in pages %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm{% if page.status == 'draft' %}" style="opacity:0.6{% endif %}">
            <div class="card-body">
              <h5 class="card-title">
                {{ page.title }}
                {% if page.status == 'draft' %}
                  <span class="badge bg-secondary ms-1">Draft</span>
                {% endif %}
              </h5>
              {% if page.summary %}
                <p class="card-text text-muted small">{{ page.summary }}</p>
              {% endif %}
            </div>
            <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
              {% if page.status != 'draft' %}
                <a href="{{ page.get_absolute_url }}" class="btn btn-sm btn-outline-primary">
                  Mehr erfahren <i class="bi bi-arrow-right ms-1"></i>
                </a>
              {% else %}
                <span></span>
              {% endif %}
              {% if request.user.is_superuser or perms.core.manage_content %}
                <a href="{% url 'cms:page-edit' page.pk %}"
                   class="btn btn-sm btn-outline-secondary" title="Bearbeiten">
                  <i class="bi bi-pencil me-1"></i>Bearbeiten
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">Noch keine Inhalte in dieser Kategorie vorhanden.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_head %}
{% if request.user.is_superuser or perms.core.manage_content %}
<link rel="stylesheet" href="{% static 'vendor/quill/quill.snow.css' %}">
{% endif %}
{% endblock %}

{% block extra_js %}
{% if request.user.is_superuser or perms.core.manage_content %}
{{ category.description|json_script:"category-description-data" }}
<script src="{% static 'vendor/quill/quill.min.js' %}"></script>
<script>
(function () {
  var initialHtml = JSON.parse(document.getElementById('category-description-data').textContent);
  var quill = new Quill('#quill-description-editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, 4, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link'],
        ['clean'],
      ]
    }
  });

  // Load existing description into editor
  if (initialHtml) {
    quill.clipboard.dangerouslyPasteHTML(initialHtml);
  }

  // Show/hide editor
  var editBtn = document.getElementById('btn-edit-description');
  var cancelBtn = document.getElementById('btn-cancel-description');
  var editorSection = document.getElementById('description-editor-section');

  editBtn.addEventListener('click', function () {
    editorSection.classList.remove('d-none');
    editBtn.classList.add('d-none');
    editorSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  cancelBtn.addEventListener('click', function () {
    editorSection.classList.add('d-none');
    editBtn.classList.remove('d-none');
  });

  // Sync Quill HTML to hidden textarea on submit
  document.getElementById('description-form').addEventListener('submit', function () {
    document.getElementById('id_description').value = quill.root.innerHTML;
  });
})();
</script>
{% endif %}
{% endblock %}

